<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Mission Report</title>
    <style>
        @page { size: a4 portrait; margin: 2cm; }
        @page main {
            size: a4 portrait; margin: 2cm;
            @frame footer_frame {
                -pdf-frame-content: footerContent;
                bottom: 1cm; margin-left: 2cm; margin-right: 2cm; height: 1cm;
            }
        }
        body { font-family: Helvetica, sans-serif; font-size: 10pt; color: #333; }
        h1 { color: #2c3e50; font-size: 18pt; border-bottom: 2px solid #2c3e50; padding-bottom: 5px; margin-top: 20px; }
        h2 { color: #2980b9; font-size: 14pt; margin-top: 15px; border-bottom: 1px solid #eee; padding-bottom: 3px; }
        h3 { color: #34495e; font-size: 11pt; margin-top: 10px; font-weight: bold; }
        
        /* Tablo Stilleri */
        table { width: 100%; border: 1px solid #ddd; margin-bottom: 10px; border-collapse: collapse; }
        th { background-color: #f2f2f2; padding: 6px; text-align: left; font-weight: bold; font-size: 9pt; border-bottom: 1px solid #999; }
        td { padding: 6px; vertical-align: top; font-size: 9pt; border-bottom: 1px solid #eee; }
        
        /* Ã–zel Kutular ve Rozetler */
        .summary-box { background-color: #f8f9fc; border-left: 4px solid #4e73df; padding: 10px; margin-bottom: 15px; }
        .narrative-box { background-color: #fff3cd; border: 1px solid #ffeeba; padding: 10px; font-style: italic; color: #856404; margin-bottom: 20px; }
        
        .stat-grid { width: 100%; border: none; margin-bottom: 10px; }
        .stat-grid td { border: none; padding: 10px; text-align: center; width: 33%; }
        .big-number { font-size: 24pt; font-weight: bold; color: #2c3e50; display: block; }
        .stat-label { font-size: 8pt; text-transform: uppercase; color: #777; }
        
        .badge-red { color: #e74a3b; font-weight: bold; }
        .badge-green { color: #1cc88a; font-weight: bold; }
        
        .two-col-table { width: 100%; border: none; }
        .two-col-table td { border: none; vertical-align: top; width: 50%; padding: 5px; }
    </style>
</head>
<body>

    <div id="footerContent" style="text-align: center; color: #666; font-size: 9pt;">
        Page <pdf:pagenumber /> of <pdf:pagecount /> | Generated by {{ generated_by }}
    </div>

    <div style="text-align: center; padding-top: 150px;">
        <h1 style="border: none; font-size: 36pt; margin-bottom: 10px;">MISSION REPORT</h1>
        <p style="font-size: 16pt; color: #7f8c8d;">Cultural Heritage Response & Risk Management</p>
        <br>
        <img src="" alt="" style="height: 2px; width: 50%; background-color: #2c3e50; display: inline-block;">
        <br><br><br>
        <p style="font-size: 12pt;"><strong>Date:</strong> {{ report_date|date:"d F Y, H:i" }}</p>
        <p style="font-size: 12pt;"><strong>Operation Status:</strong> ACTIVE</p>
        
        <br><br><br><br>
        <div class="narrative-box" style="text-align: left; margin: 20px;">
            <strong>Executive Summary:</strong><br>
            {{ narrative_text }}
        </div>

        <pdf:nexttemplate name="main" />
    </div>

    <pdf:nextpage />

    <h1>1. Operational Overview</h1>
    
    <table class="stat-grid">
        <tr>
            <td style="background-color: #e8f4f8;">
                <span class="big-number">{{ total_sites }}</span>
                <span class="stat-label">Sites Assessed</span>
            </td>
            <td style="background-color: #fcf8e3;">
                <span class="big-number">{{ total_buildings }}</span>
                <span class="stat-label">Buildings Listed</span>
            </td>
            <td style="background-color: #f8d7da;">
                <span class="big-number" style="color: #e74a3b;">{{ critical_total }}</span>
                <span class="stat-label">Critical / Collapsed</span>
            </td>
        </tr>
    </table>

    <table class="two-col-table" style="margin-top: 10px;">
        <tr>
            <td>
                <h2>Field Operations</h2>
                <table style="width: 100%;">
                    <tr>
                        <th>Metric</th>
                        <th style="text-align: right;">Count</th>
                    </tr>
                    <tr>
                        <td>Total Sectors</td>
                        <td style="text-align: right;">{{ total_sectors }}</td>
                    </tr>
                    <tr>
                        <td>Total Worksites</td>
                        <td style="text-align: right;">{{ total_worksites }}</td>
                    </tr>
                    <tr>
                        <td><span class="badge-green">Completed Worksites</span></td>
                        <td style="text-align: right; font-weight: bold;">{{ completed_worksites }}</td>
                    </tr>
                    <tr>
                        <td>Ongoing / Active</td>
                        <td style="text-align: right;">{{ ongoing_worksites }}</td>
                    </tr>
                </table>
            </td>
            <td>
                <h2>Heritage Assets</h2>
                <div class="summary-box">
                    <span style="font-size: 14pt; font-weight: bold;">{{ total_assets }}</span>
                    <br>
                    Movable Heritage Items Recorded
                </div>
            </td>
        </tr>
    </table>

    <h1>2. Human Resources & Teams</h1>
    
    <p><strong>Professional Profile Overview:</strong> {{ job_profile_text }}...</p>
    
    <table class="two-col-table">
        <tr>
            <td>
                <h3>Participants by SQ Type</h3>
                <table>
                    <tr>
                        <th>SQ Type</th>
                        <th style="text-align: right;">Count</th>
                    </tr>
                    {% for sq in sq_stats %}
                    <tr>
                        <td>{{ sq.sq_number|default:"Unspecified" }}</td>
                        <td style="text-align: right;">{{ sq.total }}</td>
                    </tr>
                    {% endfor %}
                    <tr>
                        <td style="font-weight: bold;">TOTAL</td>
                        <td style="text-align: right; font-weight: bold;">{{ total_personnel }}</td>
                    </tr>
                </table>

                <h3>Main Expertise</h3>
                <table>
                    <tr>
                        <th>Expertise (DRM/CH)</th>
                        <th style="text-align: right;">Count</th>
                    </tr>
                    {% for exp in expertise_stats %}
                    <tr>
                        <td>{{ exp.primary_expertise__code|default:"-" }}</td>
                        <td style="text-align: right;">{{ exp.total }}</td>
                    </tr>
                    {% endfor %}
                </table>
            </td>
            
            <td>
                <h3>Participants by Country</h3>
                <table>
                    <tr>
                        <th>Country</th>
                        <th style="text-align: right;">Pax</th>
                    </tr>
                    {% for c in country_stats %}
                    <tr>
                        <td>{{ c.country__name }}</td>
                        <td style="text-align: right;">{{ c.total }}</td>
                    </tr>
                    {% endfor %}
                </table>
            </td>
        </tr>
    </table>

    <pdf:nextpage />

    <h1>3. Priority Red List (Urgent)</h1>
    <p class="text-muted">Buildings classified as Severe Damage or Collapsed.</p>
    <table>
        <thead>
            <tr>
                <th width="30%">Site</th>
                <th width="30%">Building</th>
                <th width="20%">Grade</th>
                <th width="20%">Hazard</th>
            </tr>
        </thead>
        <tbody>
            {% for item in red_list %}
            <tr>
                <td>{{ item.building.site_assessment.worksite.name }}</td>
                <td>{{ item.building.building_name }}</td>
                <td>
                    {% if item.overall_damage == 'COLLAPSED' %}
                        <span style="color: #000; font-weight: bold; background-color: #ffcccc;">COLLAPSED</span>
                    {% else %}
                        <span class="badge-red">SEVERE</span>
                    {% endif %}
                </td>
                <td>{{ item.get_hazard_type_display }}</td>
            </tr>
            {% empty %}
            <tr><td colspan="4" style="text-align: center;">No critical damages reported.</td></tr>
            {% endfor %}
        </tbody>
    </table>

    <h1>4. Detailed Field Logs</h1>
    
    {% for site in all_sites %}
    <div style="margin-bottom: 25px; border: 1px solid #eee; padding: 10px;">
        <h3 style="margin: 0; color: #4e73df;">Site: {{ site.worksite.name }}</h3>
        <p style="font-size: 9pt; color: #666; border-bottom: 1px solid #ddd; padding-bottom: 5px; margin-top: 5px;">
            <strong>Ref:</strong> {{ site.site_reference_code }} | 
            <strong>Assigned Team:</strong> {{ site.assignment.team.name }} | 
            <strong>Date:</strong> {{ site.created_at|date:"d M Y" }}
        </p>

        {% if site.buildings.exists %}
            <table style="margin-top: 5px;">
                <thead>
                    <tr style="background-color: #fff;">
                        <th style="border-bottom: 2px solid #ccc;">Code / Name</th>
                        <th style="border-bottom: 2px solid #ccc;">Damage Assessment</th>
                        <th style="border-bottom: 2px solid #ccc;">Assets</th>
                    </tr>
                </thead>
                <tbody>
                    {% for b in site.buildings.all %}
                    <tr>
                        <td>
                            <strong>{{ b.building_code }}</strong><br>
                            {{ b.building_name }}
                        </td>
                        <td>
                            {% for d in b.damages.all %}
                                {% if d.overall_damage == 'NONE' %} <span style="color:green;">No Damage</span>
                                {% elif d.overall_damage == 'LIGHT' %} <span style="color:#f6c23e;">Light</span>
                                {% elif d.overall_damage == 'MODERATE' %} <span style="color:orange;">Moderate</span>
                                {% elif d.overall_damage == 'SEVERE' %} <span style="color:red; font-weight:bold;">Severe</span>
                                {% elif d.overall_damage == 'COLLAPSED' %} <span style="background-color:black; color:white; padding:2px;">Collapsed</span>
                                {% endif %}
                                <br><small>({{ d.get_hazard_type_display }})</small>
                            {% empty %}
                                <span style="color:#ccc;">Not Assessed</span>
                            {% endfor %}
                        </td>
                        <td>
                            {% if b.assets.count > 0 %}
                                <strong>{{ b.assets.count }}</strong> items
                            {% else %}
                                -
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p style="font-style: italic; color: #888;">No buildings registered in this site.</p>
        {% endif %}
    </div>
    {% endfor %}

    <pdf:nextpage />
    <h1>5. Movable Heritage Inventory</h1>
    <table>
        <thead>
            <tr>
                <th>Object Name</th>
                <th>Category</th>
                <th>Current Location</th>
            </tr>
        </thead>
        <tbody>
            {% for asset in assets_list %}
            <tr>
                <td>{{ asset.object_name }}</td>
                <td>{{ asset.category }}</td>
                <td>{{ asset.building.building_name|default:"Unknown Building" }}</td>
            </tr>
            {% empty %}
            <tr><td colspan="3">No assets recorded.</td></tr>
            {% endfor %}
        </tbody>
    </table>

</body>
</html>