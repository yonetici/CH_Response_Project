<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Mission Report</title>
    <style>
        /* 1. VARSAYILAN SAYFA (KAPAK İÇİN) - Alt bilgi yok */
        @page {
            size: a4 portrait;
            margin: 2cm;
        }

        /* 2. ANA İÇERİK SAYFASI ("main" adını verdik) - Alt bilgi var */
        @page main {
            size: a4 portrait;
            margin: 2cm;
            
            /* Sayfa Numarası Çerçevesi */
            @frame footer_frame {
                -pdf-frame-content: footerContent;
                bottom: 1cm;
                margin-left: 2cm;
                margin-right: 2cm;
                height: 1cm;
            }
        }

        body { font-family: Helvetica, sans-serif; font-size: 11pt; color: #333; }
        
        /* BAŞLIKLAR */
        h1 { color: #2c3e50; font-size: 20pt; border-bottom: 2px solid #2c3e50; padding-bottom: 5px; margin-bottom: 10px; }
        h2 { color: #2980b9; font-size: 16pt; margin-top: 20px; margin-bottom: 10px; }
        h3 { color: #34495e; font-size: 12pt; margin-top: 15px; font-weight: bold; }
        
        /* TABLOLAR */
        table { width: 100%; border: 1px solid #ddd; margin-bottom: 10px; }
        th { background-color: #f2f2f2; padding: 5px; text-align: left; font-weight: bold; font-size: 10pt; border-bottom: 1px solid #ccc; }
        td { padding: 5px; vertical-align: top; font-size: 10pt; border-bottom: 1px solid #eee; }
        
        /* ÖZEL KUTULAR */
        .summary-table { width: 100%; border: none; margin-bottom: 20px; background-color: #f9f9f9; }
        .summary-table td { border: none; text-align: center; padding: 15px; }
        .stat-number { font-size: 18pt; font-weight: bold; color: #2c3e50; display: block; }
        .stat-label { font-size: 9pt; color: #7f8c8d; text-transform: uppercase; }
        
        .badge-severe { color: #e74a3b; font-weight: bold; }
        .badge-collapsed { color: #000; font-weight: bold; }
        
        .header-info { text-align: right; font-size: 8pt; color: #999; margin-bottom: 20px; }
        .text-center { text-align: center; }
    </style>
</head>
<body>

    <div id="footerContent" style="text-align: center; color: #666; font-size: 9pt;">
        Page <pdf:pagenumber /> of <pdf:pagecount />
    </div>

    <div style="text-align: center; padding-top: 100px;">
        <h1 style="border: none; font-size: 32pt;">MISSION REPORT</h1>
        <p style="font-size: 16pt; color: #7f8c8d;">Cultural Heritage Response & Risk Management</p>
        <br><br>
        <p><strong>Date:</strong> {{ report_date|date:"d F Y, H:i" }}</p>
        <p><strong>Generated By:</strong> {{ generated_by }}</p>
        <br><br>
        
        <pdf:nexttemplate name="main" />
    </div>

    <pdf:nextpage />

    <div class="header-info">CONFIDENTIAL | CH-RIS SYSTEM</div>

    <h1>1. Executive Summary</h1>
    <p>This report consolidates field data collected from the beginning of the operation.</p>

    <table class="summary-table">
        <tr>
            <td>
                <span class="stat-number">{{ total_sites }}</span>
                <br>
                <span class="stat-label">Sites Assessed</span>
            </td>
            <td>
                <span class="stat-number">{{ total_buildings }}</span>
                <br>
                <span class="stat-label">Buildings</span>
            </td>
            <td>
                <span class="stat-number" style="color: #e74a3b;">{{ critical_total }}</span>
                <br>
                <span class="stat-label">Critical</span>
            </td>
        </tr>
    </table>

    <p>
        As of <strong>{{ report_date|date:"d F Y" }}</strong>, field teams have completed assessments for <strong>{{ total_sites }}</strong> heritage sites. 
        <strong>{{ critical_total }}</strong> buildings have been flagged for urgent intervention.
    </p>

    <h2>2. Priority Red List (Urgent)</h2>
    <table>
        <thead>
            <tr>
                <th width="30%">Site</th>
                <th width="30%">Building</th>
                <th width="20%">Grade</th>
                <th width="20%">Hazard</th>
            </tr>
        </thead>
        <tbody>
            {% for item in red_list %}
            <tr>
                <td>{{ item.building.site_assessment.worksite.name }}</td>
                <td>{{ item.building.building_name }}</td>
                <td>
                    {% if item.overall_damage == 'COLLAPSED' %}
                        <span class="badge-collapsed">COLLAPSED</span>
                    {% else %}
                        <span class="badge-severe">SEVERE</span>
                    {% endif %}
                </td>
                <td>{{ item.get_hazard_type_display }}</td>
            </tr>
            {% empty %}
            <tr><td colspan="4" class="text-center">No critical damages reported.</td></tr>
            {% endfor %}
        </tbody>
    </table>

    <pdf:nextpage />

    <h1>3. Detailed Field Logs</h1>
    
    {% for site in all_sites %}
    <div style="margin-bottom: 20px; border-bottom: 1px solid #ccc; padding-bottom: 10px;">
        <h3>Site: {{ site.worksite.name }}</h3>
        <p style="font-size: 9pt;">
            Ref: {{ site.site_reference_code }} | Team: {{ site.editor_name }}
        </p>

        {% if site.buildings.exists %}
            <table>
                <thead>
                    <tr>
                        <th>Code</th>
                        <th>Name</th>
                        <th>Damage</th>
                        <th>Assets</th>
                    </tr>
                </thead>
                <tbody>
                    {% for b in site.buildings.all %}
                    <tr>
                        <td>{{ b.building_code }}</td>
                        <td>{{ b.building_name }}</td>
                        <td>
                            {% for d in b.damages.all %}
                                {{ d.get_overall_damage_display }}
                            {% empty %}
                                -
                            {% endfor %}
                        </td>
                        <td>{{ b.assets.count }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p style="color: #666; font-style: italic;">No building details.</p>
        {% endif %}
    </div>
    {% endfor %}

    <pdf:nextpage />
    <h1>4. Movable Heritage</h1>
    <p>Total assets: <strong>{{ total_assets }}</strong></p>
    
    <table>
        <thead>
            <tr>
                <th>Object</th>
                <th>Category</th>
                <th>Location</th>
            </tr>
        </thead>
        <tbody>
            {% for asset in assets_list %}
            <tr>
                <td>{{ asset.object_name }}</td>
                <td>{{ asset.category }}</td>
                <td>{{ asset.building.building_name|default:"Unknown" }}</td>
            </tr>
            {% empty %}
            <tr><td colspan="3">No assets recorded.</td></tr>
            {% endfor %}
        </tbody>
    </table>

</body>
</html>