{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid">
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            {% if form.instance.pk %}
                <i class="fas fa-edit me-2"></i>Edit Worksite: {{ form.instance.name }}
            {% else %}
                <i class="fas fa-plus-circle me-2"></i>New Worksite
            {% endif %}
        </h1>
    </div>

    <div class="row">
        <div class="col-lg-7">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex justify-content-between align-items-center bg-light">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-map-marked-alt me-1"></i> Location & Area
                    </h6>
                    
                    <div class="form-check form-switch mb-0">
                        <input class="form-check-input" type="checkbox" id="toggleSectors" checked>
                        <label class="form-check-label small fw-bold text-secondary" for="toggleSectors">Show Sectors</label>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div id="map" style="height: 550px; width: 100%;"></div>
                </div>
                <div class="card-footer small text-muted">
                    <i class="fas fa-info-circle"></i> Use the toolbar on the left to draw a <strong>Polygon</strong> (area) or place a <strong>Marker</strong> (point). The system will auto-detect the Sector.
                </div>
            </div>
        </div>

        <div class="col-lg-5">
            <form method="post" id="worksiteForm">
                {% csrf_token %}
                
                <div style="display:none;">
                    {{ form.location_data }}
                </div>

                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">Worksite Details</h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Worksite Name</label>
                            {{ form.name }}
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">
                                Assigned Sector 
                                <span class="badge bg-info ms-1"><i class="fas fa-magic"></i> Auto-Detect</span>
                            </label>
                            {{ form.sector }}
                            <small class="text-muted d-block mt-1" style="font-size: 0.8rem;">
                                Generated automatically based on the location you draw.
                            </small>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Description</label>
                            {{ form.description }}
                        </div>
                    </div>
                </div>

                <div class="card shadow mb-4 border-left-success">
                    <div class="card-header py-3 bg-light d-flex justify-content-between align-items-center">
                        <h6 class="m-0 font-weight-bold text-success">
                            <i class="fas fa-check-double me-1"></i> Closure & Status
                        </h6>
                        
                        <button type="button" class="btn btn-sm btn-success shadow-sm" onclick="markAsCompleted()">
                            <i class="fas fa-flag-checkered me-1"></i> Complete Now
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold small text-uppercase text-gray-600">Current Status</label>
                                {{ form.status }}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold small text-uppercase text-gray-600">Completion Date</label>
                                {{ form.completion_date }}
                            </div>
                        </div>
                        <div class="alert alert-light border small mb-0 p-2 text-muted">
                            <i class="fas fa-lightbulb text-warning me-1"></i> 
                            Click "Complete Now" to automatically set status to <strong>Closed</strong> and date to <strong>Today</strong>.
                        </div>
                    </div>
                </div>

                <div class="d-grid gap-2 d-md-flex justify-content-md-end mb-4">
                    <a href="{% url 'worksite_list' %}" class="btn btn-secondary me-md-2">
                        <i class="fas fa-arrow-left me-1"></i> Cancel
                    </a>
                    <button type="submit" class="btn btn-primary btn-lg px-4">
                        <i class="fas fa-save me-1"></i> Save Worksite
                    </button>
                </div>

            </form>
        </div>
    </div>
</div>

{{ sectors_json|json_script:"sectors-data" }}

{% endblock %}

{% block extra_js %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

<script>
    // --- 1. VERİLERİN ALINMASI ---
    var allSectors = JSON.parse(document.getElementById('sectors-data').textContent);
    var locationInput = document.getElementById('id_location_data');
    var sectorSelect = $('#id_sector'); // Select2 kullanıyorsak jQuery seçicisi

    // --- 2. HARİTA BAŞLATMA ---
    var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '© OpenStreetMap' });
    var satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Tiles © Esri' });

    var map = L.map('map', {
        center: [40.1885, 29.0610],
        zoom: 12,
        layers: [osm]
    });

    L.control.layers({ "Street Map": osm, "Satellite": satellite }).addTo(map);

    // --- 3. KATMANLAR ---
    var drawnItems = new L.FeatureGroup().addTo(map);       // Kullanıcının çizdiği (Worksite)
    var sectorLayerGroup = L.layerGroup().addTo(map);       // Arka plandaki sektörler

    // Sektörleri Çiz (Referans için)
    if (allSectors) {
        allSectors.forEach(function(s) {
            if (s.geometry) {
                L.geoJSON(s.geometry, {
                    interactive: false, // Tıklamalar alttaki çizime geçsin
                    style: { color: s.color, weight: 2, fillOpacity: 0.1, dashArray: '5, 5' }
                }).addTo(sectorLayerGroup);
            }
        });
    }

    // Toggle Sektörler
    document.getElementById('toggleSectors').addEventListener('change', function() {
        if (this.checked) { map.addLayer(sectorLayerGroup); } 
        else { map.removeLayer(sectorLayerGroup); }
    });

    // --- 4. MEVCUT WORKSITE YÜKLEME (EDIT MODE) ---
    if (locationInput.value) {
        try {
            var geom = JSON.parse(locationInput.value);
            var layer = L.GeoJSON.geometryToLayer(geom);
            
            // Eğer Polygon ise stil ver
            if (geom.type === 'Polygon' || geom.type === 'MultiPolygon') {
                layer.setStyle({ color: '#4e73df', fillColor: '#4e73df', fillOpacity: 0.4, weight: 3 });
            }
            
            drawnItems.addLayer(layer);
            map.fitBounds(drawnItems.getBounds(), { maxZoom: 16, padding: [50, 50] });
        } catch(e) { console.error("GeoJSON Load Error:", e); }
    }

    // --- 5. ÇİZİM KONTROLLERİ (Leaflet.Draw) ---
    var drawControl = new L.Control.Draw({
        draw: {
            polyline: false, 
            circle: false, 
            circlemarker: false,
            polygon: { allowIntersection: false, showArea: true },
            rectangle: true, 
            marker: true
        },
        edit: {
            featureGroup: drawnItems, 
            remove: true
        }
    });
    map.addControl(drawControl);

    // --- 6. ÇİZİM OLAYLARI & SEKTÖR ALGILAMA ---
    
    // Yeni çizim yapıldığında
    map.on(L.Draw.Event.CREATED, function (e) {
        drawnItems.clearLayers(); // Sadece 1 şekil olabilir
        var layer = e.layer;
        
        // Stili ayarla
        if (layer instanceof L.Polygon) {
            layer.setStyle({ color: '#4e73df', fillColor: '#4e73df', fillOpacity: 0.4 });
        }
        
        drawnItems.addLayer(layer);
        updateLocationAndSector(layer);
    });

    // Çizim düzenlendiğinde
    map.on(L.Draw.Event.EDITED, function (e) {
        e.layers.eachLayer(function (layer) {
            updateLocationAndSector(layer);
        });
    });

    // --- YARDIMCI: Input Güncelleme ve Turf.js ile Analiz ---
    function updateLocationAndSector(layer) {
        // A. GeoJSON'u Input'a Yaz
        var geometry = layer.toGeoJSON().geometry;
        locationInput.value = JSON.stringify(geometry);

        // B. Turf.js ile Sektör Bul
        var pointToCheck;
        if (geometry.type === 'Point') {
            pointToCheck = turf.point(geometry.coordinates);
        } else {
            pointToCheck = turf.centroid(geometry); // Polygon ise merkezini al
        }

        var foundSectorId = null;
        var foundSectorName = "";

        if (allSectors) {
            allSectors.forEach(function(s) {
                if (s.geometry) {
                    var sectorPoly = turf.polygon(s.geometry.coordinates);
                    if (turf.booleanPointInPolygon(pointToCheck, sectorPoly)) {
                        foundSectorId = s.id;
                        foundSectorName = s.name;
                    }
                }
            });
        }

        // C. Selectbox'ı Güncelle
        if (foundSectorId) {
            sectorSelect.val(foundSectorId).trigger('change'); // Select2 için trigger
            
            // Kullanıcıya küçük bir popup ile bilgi ver
            var center = (layer.getBounds ? layer.getBounds().getCenter() : layer.getLatLng());
            L.popup({closeButton: false, autoClose: true, className: 'success-popup'})
                .setLatLng(center)
                .setContent('<div class="text-center text-success fw-bold"><i class="fas fa-check"></i> Sector: ' + foundSectorName + '</div>')
                .openOn(map);
        }
    }

    // --- 7. YENİ FONKSİYON: Worksite Kapatma (JS) ---
    function markAsCompleted() {
        // 1. Status'ü COMPLETED yap
        var statusField = document.getElementById('id_status');
        if(statusField) {
            statusField.value = 'COMPLETED';
        }

        // 2. Tarihi Bugün Yap
        var dateField = document.getElementById('id_completion_date');
        if(dateField) {
            var today = new Date();
            var yyyy = today.getFullYear();
            var mm = String(today.getMonth() + 1).padStart(2, '0');
            var dd = String(today.getDate()).padStart(2, '0');
            dateField.value = yyyy + '-' + mm + '-' + dd;
        }

        // 3. Görsel Geri Bildirim
        alert("Worksite marked as Completed for today (" + yyyy + '-' + mm + '-' + dd + ").\nDon't forget to click 'Save Worksite'.");
    }

    // Select2 Başlatma (Eğer projede varsa şık görünür)
    $(document).ready(function() {
        $('.select2-sector').select2({ theme: 'bootstrap-5', width: '100%' });
    });
</script>
{% endblock %}